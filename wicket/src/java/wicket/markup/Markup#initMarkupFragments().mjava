	/**
	 * Until we started with AJAX we iterated over the markup and tried to find
	 * the component. With AJAX however we need to find the Markup for a
	 * Component. In an attempt to change Wicket internals step by step,
	 * initMarkupFragments() create a hierarchal structure of MarkupFragments
	 * and other MarkupElements based on the simple List of elements per Markup
	 * file whixh we have now.
	 * 
	 */
	private void initMarkupFragments()
	{
		this.markupFragments = new MarkupFragment(this);
		MarkupFragment current = this.markupFragments;

		for (MarkupElement elem : this.markup)
		{
			if (elem instanceof RawMarkup)
			{
				current.addMarkupElement(elem);
			}
			else
			// if (elem instanceof ComponentTag)
			{
				final ComponentTag tag = (ComponentTag)elem;
				if (tag.isOpen())
				{
					if (tag.hasNoCloseTag())
					{
						new MarkupFragment(this, current, tag);
					}
					else
					{
						current = new MarkupFragment(this, current, tag);
					}
				}
				else if (tag.isOpenClose())
				{
					new MarkupFragment(this, current, tag);
				}
				else
				// if (tag.isClose()
				{
					current.addMarkupElement(tag);
					current = current.getParentFragment();
				}
			}
		}
	}

