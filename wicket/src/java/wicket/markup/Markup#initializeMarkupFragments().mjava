	/**
	 * In an attempt to change Wicket internals step by step,
	 * initializeMarkupFragments() creates a hierarchal structure of
	 * MarkupFragments and other MarkupElements based on the simple List of
	 * elements per Markup file which we have today.
	 */
	private void initializeMarkupFragments()
	{
		if (markup == null)
		{
			return;
		}

		this.markupFragments = new MarkupFragment(this);

		// Remember the path associated with a ComponentTag to properly walk up
		// and down the hierarchy of wicket markup tags
		Stack<String> stack = new Stack<String>();
		String basePath = null;

		Stack<MarkupFragment> fragmentStack = new Stack<MarkupFragment>();
		MarkupFragment current = this.markupFragments;

		// For all markup element in the external markup file
		for (MarkupElement elem : this.markup)
		{
			// If RawMarkup simply add the element to the current fragment
			if (elem instanceof RawMarkup)
			{
				current.addMarkupElement(elem);
			}
			else
			// if (elem instanceof ComponentTag)
			{
				// Construct the markup path for the tag
				final ComponentTag tag = (ComponentTag)elem;
				final String path = (basePath == null ? tag.getId() : basePath
						+ Component.PATH_SEPARATOR + tag.getId());

				// Depending on tag type (open, close, open-close) ...
				if (tag.isOpen())
				{
					// Open tags with no close tags (HTML) are treated like
					// open-close.
					if (tag.hasNoCloseTag())
					{
						current.addMarkupElement(new MarkupFragment(this, tag));
					}
					else
					{
						// If open tag and auto component (BODY, HEAD, etc.)
						// than the markup path gets not updated as the markup
						// for BODY e.g. does not have a wicket:id.

						stack.push(basePath);
						fragmentStack.push(current);

						MarkupFragment newFragment = new MarkupFragment(this, tag);
						current.addMarkupElement(newFragment);
						current = newFragment;

						if (!tag.getId().startsWith(Component.AUTO_COMPONENT_PREFIX))
						{
							basePath = path;
						}
					}
				}
				else if (tag.isOpenClose())
				{
					MarkupFragment newFragment = new MarkupFragment(this, tag);
					current.addMarkupElement(newFragment);
				}
				else
				// if (tag.isClose()
				{
					current.addMarkupElement(tag);
					current = fragmentStack.pop();
					basePath = stack.pop();
				}
			}
		}

		if ((this.markupFragments.size() == 1)
				&& (this.markupFragments.get(0) instanceof MarkupFragment))
		{
			this.markupFragments = (MarkupFragment)this.markupFragments.get(0);
		}
	}

