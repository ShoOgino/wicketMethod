	/**
	 * Updates the session, e.g. for replication purposes.
	 */
	protected void update()
	{
		// If state is dirty
		if (dirty)
		{
			if (log.isDebugEnabled())
			{
				log.debug("updateCluster(): Session is dirty.  Replicating.");
			}

			// State is no longer dirty
			this.dirty = false;

			// Set attribute.
			setAttribute(SESSION_ATTRIBUTE_NAME, this);
		}
		else
		{
			if (log.isDebugEnabled())
			{
				log.debug("updateCluster(): Session not dirty.");
			}
		}

		// Go through all pages in all page maps, replicating any dirty pages
		visitPageMaps(new IVisitor()
		{
			public void pageMap(PageMap pageMap)
			{
				pageMap.visitPages(new PageMap.IVisitor()
				{
					public void page(Page page)
					{
						if (page.isDirty())
						{
							page.setDirty(false);
							replicate(page);
						}
					}
				});
			}
		});
	}

